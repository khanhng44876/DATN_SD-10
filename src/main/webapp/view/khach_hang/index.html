<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<!--<div th:if="${session.khachHang != null}">-->
<!--    <div th:if="${session.khachHang.chucVu == 'QL'}">-->

        <head>
            <title>Quản Lý Khách Hàng</title>
            <meta charset="utf-8">
            <head th:replace="giao_dien_chinh/libAdmin :: libheaderadmin"></head>
            <link rel="stylesheet" type="text/css" href="/css/style.css">
        </head>
        <body>
        <div>
            <div th:replace="giao_dien_chinh/navbarAdmin :: headerAdmin"></div>
            <div class="d-flex">
                <div th:replace="giao_dien_chinh/navbarAdmin :: sidenavAdmin"></div>
                <div class="pt-3" style="width: calc(100% - 250px);">
                    <div class="container">
                        <h2 style="text-align: center;">Quản Lý Khách Hàng</h2>

                        <table id="example" class="table table-bordered">
                            <thead>
                            <tr>
                                <th>ID</th>
                                <th>Tên Khách Hàng</th>
                                <th>Email</th>
                                <th>Số điện thoại</th>
                                <th>Địa chỉ</th>
                                <th>Ngày sinh</th>
                                <th>Tài Khoản</th>
                                <th>Mật khẩu</th>
                                <th>Giới tính</th>
                                <th>Hành động</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="d : ${listkh}">
                                <td th:text="${d.id}"></td>
                                <td th:text="${d.tenKhachHang}"></td>
                                <td th:text="${d.email}"></td>
                                <td th:text="${d.soDienThoai}"></td>
                                <td th:text="${d.diaChi}"></td>
                                <td th:text="${d.ngaySinh}"></td>
                                <td th:text="${d.taiKhoan}"></td>
                                <td th:text="${d.matKhau}"></td>
                                <td th:text="${d.gioiTinh}"></td>
                                <td>
                                    <button th:onclick="'loadKHData(' + ${d.id} + ')'" class="btn btn-warning">
                                        <i class="fa fa-pencil-alt"></i>
                                    </button>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                        <br><br>
                        <!-- Form Thêm Khách Hàng -->
                        <div class="row">
                            <div class="col-sm-13">
                                <label class="lb-form">Tên Khách Hàng</label>
                                <input id="tenKhachHang" class="form-control" required>
                                <span id="errorTenKhachHang" class="text-danger"></span>

                                <label class="lb-form">Email</label>
                                <input id="email" class="form-control" required>
                                <span id="errorEmail" class="text-danger"></span>

                                <label class="lb-form">Số điện thoại</label>
                                <input id="soDienThoai" class="form-control" required>
                                <span id="errorSoDienThoai" class="text-danger"></span>

                                <label class="lb-form">Địa chỉ</label>
                                <input id="diaChi" class="form-control" required>
                                <span id="errorDiaChi" class="text-danger"></span>

                                <label class="lb-form">Ngày sinh</label>
                                <input id="ngaySinh" class="form-control" type="date" required>
                                <span id="errorNgaySinh" class="text-danger"></span>

                                <label class="lb-form">Tài khoản</label>
                                <input id="taiKhoan" class="form-control" type="form-control" required>
                                <span id="errorTaiKhoan" class="text-danger"></span>

                                <label class="lb-form">Mật khẩu</label>
                                <input id="matKhau" class="form-control" type="form-control" required>
                                <span id="errorMatKhau" class="text-danger"></span>

                                <label class="lb-form">Giới tính</label>
                                <input id="gioiTinh" class="form-control" type="form-control" required>
                                <span id="errorGioiTinh" class="text-danger"></span>
                                <br>
                                <button onclick="validateForm('add')" class="btn btn-primary">Thêm</button>
                                <button onclick="validateForm('update')" class="btn btn-warning">Cập Nhật</button>
                                <br><br>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </body>
        <script>
            $('#example').DataTable();
        </script>

        <script th:inline="javascript">
            function validateForm(action) {
                document.getElementById("errorTenKhachHang").innerText = "";
                document.getElementById("errorEmail").innerText = "";
                document.getElementById("errorSoDienThoai").innerText = "";
                document.getElementById("errorDiaChi").innerText = "";
                document.getElementById("errorNgaySinh").innerText = "";
                document.getElementById("errorTaiKhoan").innerText = "";
                document.getElementById("errorMatKhau").innerText = "";
                document.getElementById("errorGioiTinh").innerText = "";

                const tenKhachHang = document.getElementById("tenKhachHang").value.trim();
                const email = document.getElementById("email").value.trim();
                const soDienThoai = document.getElementById("soDienThoai").value.trim();
                const diaChi = document.getElementById("diaChi").value.trim();
                const ngaySinh = document.getElementById("ngaySinh").value.trim();
                const taiKhoan = document.getElementById("taiKhoan").value.trim();
                const matKhau = document.getElementById("matKhau").value.trim();
                const gioiTinh = document.getElementById("gioiTinh").value.trim();

                let isValid = true;

                if (tenKhachHang === "") {
                    document.getElementById("errorTenKhachHang").innerText = "Tên khách hàng không được để trống.";
                    isValid = false;
                }
                if (email === "" || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                    document.getElementById("errorEmail").innerText = "Email không hợp lệ.";
                    isValid = false;
                }
                if (soDienThoai === "" || !/^[0-9]{10,11}$/.test(soDienThoai)) {
                    document.getElementById("errorSoDienThoai").innerText = "Số điện thoại không hợp lệ.";
                    isValid = false;
                }
                if (diaChi === "") {
                    document.getElementById("errorDiaChi").innerText = "Địa chỉ không được để trống.";
                    isValid = false;
                }
                if (ngaySinh === "") {
                    document.getElementById("errorNgaySinh").innerText = "Ngày sinh không được để trống.";
                    isValid = false;
                }
                if (taiKhoan === "") {
                    document.getElementById("errorTaiKhoan").innerText = "Tài  không được để trống.";
                    isValid = false;
                }
                if (matKhau === "") {
                    document.getElementById("errorMatKhau").innerText = "Mật khẩu không được để trống.";
                    isValid = false;
                }
                if (gioiTinh === "") {
                    document.getElementById("errorGioiTinh").innerText = "Giới tính không được để trống.";
                    isValid = false;
                }

                if (isValid) {
                    if (action === 'add') {
                        themKhachHang();
                    } else if (action === 'update') {
                        capNhatKhachHang(window.currentNVId);
                    }
                }
            }


            async function loadKHData(idkh) {
                console.log("ID khách hàng nhận được:", idkh); // In ra để kiểm tra idsp
                try {
                    const id = parseInt(idkh, 10);
                    if (isNaN(id)) {
                        console.error("ID khách hàng không hợp lệ:", idkh);
                        alert("ID khách hàng không hợp lệ.");
                        return;
                    }
                    // Gửi yêu cầu GET đến server để lấy dữ liệu sản phẩm
                    const response = await fetch(`/khach-hang/danh-sach-khach-hang/${id}`);

                    // Kiểm tra nếu phản hồi không thành công
                    if (!response.ok) {
                        console.error("Lỗi khi tải dữ liệu khách hàng:", response.statusText);
                        alert("Không thể tải dữ liệu khách hàng.");
                        return;
                    }

                    const khachHang = await response.json();

                    // Điền dữ liệu vào form
                    document.getElementById("tenKhachHang").value = khachHang.tenKhachHang;
                    document.getElementById("email").value = khachHang.email;
                    document.getElementById("soDienThoai").value = khachHang.soDienThoai;
                    document.getElementById("diaChi").value = khachHang.diaChi;
                    document.getElementById("ngaySinh").value = khachHang.ngaySinh;
                    document.getElementById("taiKhoan").value = khachHang.taiKhoan;
                    document.getElementById("matKhau").value = khachHang.matKhau;
                    document.getElementById("gioiTinh").value = khachHang.gioiTinh;

                    window.currentNVId = idkh;
                } catch (error) {
                    console.error("Đã có lỗi xảy ra khi tải dữ liệu khách hàng:", error);
                    // alert("Không thể tải dữ liệu nhân viên.");
                }
            }

            async function themKhachHang() {
                var con = window.confirm("Bạn có chắc chắn muốn thêm khách hàng?");
                if (con == false) {
                    return;
                }

                // Thu thập dữ liệu từ form
                var payload = {
                    "tenKhachHang": document.getElementById("tenKhachHang").value,
                    "email": document.getElementById("email").value,
                    "soDienThoai": document.getElementById("soDienThoai").value,
                    "diaChi": document.getElementById("diaChi").value,
                    "ngaySinh": document.getElementById("ngaySinh").value,
                    "taiKhoan": document.getElementById("taiKhoan").value,
                    "matKhau": document.getElementById("matKhau").value,
                    "gioiTinh": document.getElementById("gioiTinh").value,
                };

                // Gửi dữ liệu đến server (POST request)
                const response = await fetch("/khach-hang/them-khach-hang", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload) // Chuyển dữ liệu thành JSON
                });

                // Kiểm tra phản hồi từ server
                if (response.ok) {
                alert("Khách hàng đã được thêm thành công!");
                // Chuyển hướng về trang hiển thị danh sách sản phẩm
                window.location.href = "/khach-hang/hien-thi";
            } else {
                alert("Đã có lỗi xảy ra khi thêm khách hàng." +
                    "Dữ liệu khách hàng không được trùng.");
            }
            }

            async function capNhatKhachHang(idkh) {
                var con = window.confirm("Bạn có chắc chắn muốn cập nhật khách hàng?");
                if (con == false) {
                    return;
                }

                // Thu thập dữ liệu từ form
                var payload = {
                    "tenKhachHang": document.getElementById("tenKhachHang").value,
                    "email": document.getElementById("email").value,
                    "soDienThoai": document.getElementById("soDienThoai").value,
                    "diaChi": document.getElementById("diaChi").value,
                    "ngaySinh": document.getElementById("ngaySinh").value,
                    "taiKhoan": document.getElementById("taiKhoan").value,
                    "matKhau": document.getElementById("matKhau").value,
                    "gioiTinh": document.getElementById("gioiTinh").value,
                };

                // Gửi dữ liệu đến server (PUT request)
                const response = await fetch(`/khach-hang/cap-nhat-khach-hang/${idkh}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload) // Chuyển dữ liệu thành JSON
                });

                // Kiểm tra phản hồi từ server
                if (response.ok) {
                    alert("Khách hàng đã được cập nhật thành công!");
                    // Chuyển hướng về trang hiển thị danh sách sản phẩm
                    window.location.href = "/khach-hang/hien-thi";
                } else {
                    alert("Đã có lỗi xảy ra khi cập nhật khách hàng.");
                }
            }
        </script>

<!--        <p>Chào mừng Quản Lý</p>-->
<!--    </div>-->
<!--    <div th:if="${session.khachHang.chucVu != 'QL'}">-->
<!--        <p>Bạn không có quyền truy cập trang này.</p>-->
<!--    </div>-->
<!--</div>-->
<!--<div th:if="${session.khachHang == null}">-->
<!--    <p>Vui lòng <a th:href="@{/dang-nhap/login}">đăng nhập</a>.</p>-->
<!--</div>-->

</html>
